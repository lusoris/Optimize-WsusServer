name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    name: Build Release
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $version = $tag -replace '^v', ''
          Write-Host "Version: $version"
          "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Verify manifest version matches tag
        shell: pwsh
        run: |
          $tagVersion = "${{ steps.version.outputs.version }}"
          $manifest = Import-PowerShellDataFile './Optimize-WsusServer.psd1'
          $manifestVersion = $manifest.ModuleVersion

          Write-Host "Manifest version: $manifestVersion"
          Write-Host "Tag version: $tagVersion"

          if ($manifestVersion -ne $tagVersion) {
              Write-Host "::warning::Manifest version ($manifestVersion) does not match tag version ($tagVersion)"
              Write-Host "Consider updating the manifest version before release"
          }

      - name: Validate Module Manifest
        shell: pwsh
        run: |
          try {
              $manifest = Test-ModuleManifest -Path './Optimize-WsusServer.psd1' -ErrorAction Stop
              Write-Host "Module validation passed"
              Write-Host "  Name: $($manifest.Name)"
              Write-Host "  Version: $($manifest.Version)"
              Write-Host "  Functions: $($manifest.ExportedFunctions.Count)"
          }
          catch {
              Write-Host "::error::Module manifest validation failed: $_"
              exit 1
          }

      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser

          $paths = @('./Public', './Private', './Build') | Where-Object { Test-Path $_ }

          $results = @()
          foreach ($path in $paths) {
            $results += Invoke-ScriptAnalyzer -Path $path -Recurse -Settings ./PSScriptAnalyzerSettings.psd1
          }

          $errors = ($results | Where-Object Severity -eq 'Error').Count

          if ($errors -gt 0) {
              $results | Where-Object Severity -eq 'Error' | Format-Table -AutoSize
              Write-Host "::error::PSScriptAnalyzer found $errors error(s)"
              exit 1
          }

          Write-Host "PSScriptAnalyzer passed (Errors: 0)"

      - name: Build monolithic script
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          .\Build\Build-MonolithicScript.ps1 -Version $version

      - name: Validate built script
        shell: pwsh
        run: |
          $scriptPath = './dist/Optimize-WsusServer.ps1'

          # Syntax check
          $errors = $null
          $null = [System.Management.Automation.Language.Parser]::ParseFile($scriptPath, [ref]$null, [ref]$errors)

          if ($errors) {
              Write-Host "::error::Syntax errors in built script"
              $errors | ForEach-Object { Write-Host $_.Message }
              exit 1
          }

          $fileInfo = Get-Item $scriptPath
          Write-Host "Build validation passed"
          Write-Host "  Size: $([math]::Round($fileInfo.Length / 1KB, 1)) KB"
          Write-Host "  Lines: $((Get-Content $scriptPath).Count)"

      - name: Generate checksums
        id: checksums
        shell: pwsh
        run: |
          $scriptHash = Get-FileHash './dist/Optimize-WsusServer.ps1' -Algorithm SHA256 | Select-Object -ExpandProperty Hash
          $manifestHash = Get-FileHash './Optimize-WsusServer.psd1' -Algorithm SHA256 | Select-Object -ExpandProperty Hash

          Write-Host "Script SHA256: $scriptHash"
          Write-Host "Manifest SHA256: $manifestHash"

          "script_hash=$scriptHash" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "manifest_hash=$manifestHash" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Generate release notes
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $scriptHash = "${{ steps.checksums.outputs.script_hash }}"

          $notes = @"
          ## Optimize-WsusServer v$version

          ### Downloads

          | File | Description |
          |------|-------------|
          | ``Optimize-WsusServer.ps1`` | Monolithic script for production use |
          | ``Optimize-WsusServer.psd1`` | Module manifest (for module installation) |

          ### Quick Start

          **Option 1: Monolithic Script (Recommended for production)**

          ``````powershell
          # Download and run
          .\Optimize-WsusServer.ps1 -HealthCheck
          ``````

          **Option 2: PowerShell Module (For development)**

          ``````powershell
          # Clone repository and import
          Import-Module .\Optimize-WsusServer.psd1
          Get-WsusHealthStatus
          ``````

          ### Requirements

          - Windows Server 2012 R2 / 2016 / 2019 / 2022 / 2025
          - Windows PowerShell 5.1 (not PowerShell 7)
          - SqlServer PowerShell module
          - Administrator privileges

          ### Checksums

          ``````
          Optimize-WsusServer.ps1 SHA256: $scriptHash
          ``````

          ### Documentation

          Full documentation available at [docs/](https://github.com/lusoris/Optimize-WsusServer/tree/main/docs)
          "@

          $notes | Out-File -FilePath release-notes.md -Encoding utf8

      - name: Create module archive
        shell: pwsh
        run: |
          # Create a zip with module files for those who want the full module
          $moduleFiles = @(
            'Optimize-WsusServer.psd1',
            'Optimize-WsusServer.psm1',
            'Public',
            'Private',
            'Data',
            'LICENSE',
            'README.md'
          )

          $tempDir = New-Item -ItemType Directory -Path './release-module' -Force
          foreach ($file in $moduleFiles) {
            if (Test-Path $file) {
              Copy-Item -Path $file -Destination $tempDir -Recurse -Force
            }
          }

          Compress-Archive -Path "$tempDir/*" -DestinationPath './Optimize-WsusServer-Module.zip' -Force
          Remove-Item $tempDir -Recurse -Force

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Optimize-WsusServer v${{ steps.version.outputs.version }}"
          body_path: release-notes.md
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
          files: |
            dist/Optimize-WsusServer.ps1
            Optimize-WsusServer.psd1
            Optimize-WsusServer-Module.zip
            LICENSE
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
