name: Release

# Automatically triggered when a version tag is pushed (e.g., git push origin v2.1.0)
# Three jobs run in sequence:
# 1. build - Validates manifest, builds monolithic script, generates release notes
# 2. publish-gallery - Publishes module to PowerShell Gallery (optional, requires NUGET_KEY secret)
# 3. post-release - Updates CHANGELOG.md and creates version bump commit

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    name: Build Release
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $version = $tag -replace '^v', ''
          Write-Host "Version: $version"
          "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Verify manifest version matches tag
        shell: pwsh
        run: |
          $tagVersion = "${{ steps.version.outputs.version }}"
          $manifest = Import-PowerShellDataFile './Optimize-WsusServer.psd1'
          $manifestVersion = $manifest.ModuleVersion

          Write-Host "Manifest version: $manifestVersion"
          Write-Host "Tag version: $tagVersion"

          if ($manifestVersion -ne $tagVersion) {
              Write-Host "::warning::Manifest version ($manifestVersion) does not match tag version ($tagVersion)"
              Write-Host "Consider updating the manifest version before release"
          }

      - name: Validate Module Manifest
        shell: pwsh
        run: |
          try {
              $manifest = Test-ModuleManifest -Path './Optimize-WsusServer.psd1' -ErrorAction Stop
              Write-Host "Module validation passed"
              Write-Host "  Name: $($manifest.Name)"
              Write-Host "  Version: $($manifest.Version)"
              Write-Host "  Functions: $($manifest.ExportedFunctions.Count)"
          }
          catch {
              Write-Host "::error::Module manifest validation failed: $_"
              exit 1
          }

      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser

          $paths = @('./Public', './Private', './Build') | Where-Object { Test-Path $_ }

          $results = @()
          foreach ($path in $paths) {
            $results += Invoke-ScriptAnalyzer -Path $path -Recurse -Settings ./PSScriptAnalyzerSettings.psd1
          }

          $errors = ($results | Where-Object Severity -eq 'Error').Count

          if ($errors -gt 0) {
              $results | Where-Object Severity -eq 'Error' | Format-Table -AutoSize
              Write-Host "::error::PSScriptAnalyzer found $errors error(s)"
              exit 1
          }

          Write-Host "PSScriptAnalyzer passed (Errors: 0)"

      - name: Build monolithic script
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          .\Build\Build-MonolithicScript.ps1 -Version $version

      - name: Validate built script
        shell: pwsh
        run: |
          $scriptPath = './dist/Optimize-WsusServer.ps1'

          # Syntax check
          $errors = $null
          $null = [System.Management.Automation.Language.Parser]::ParseFile($scriptPath, [ref]$null, [ref]$errors)

          if ($errors) {
              Write-Host "::error::Syntax errors in built script"
              $errors | ForEach-Object { Write-Host $_.Message }
              exit 1
          }

          $fileInfo = Get-Item $scriptPath
          Write-Host "Build validation passed"
          Write-Host "  Size: $([math]::Round($fileInfo.Length / 1KB, 1)) KB"
          Write-Host "  Lines: $((Get-Content $scriptPath).Count)"

      - name: Generate checksums
        id: checksums
        shell: pwsh
        run: |
          $scriptHash = Get-FileHash './dist/Optimize-WsusServer.ps1' -Algorithm SHA256 | Select-Object -ExpandProperty Hash
          $manifestHash = Get-FileHash './Optimize-WsusServer.psd1' -Algorithm SHA256 | Select-Object -ExpandProperty Hash

          Write-Host "Script SHA256: $scriptHash"
          Write-Host "Manifest SHA256: $manifestHash"

          "script_hash=$scriptHash" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "manifest_hash=$manifestHash" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Generate release notes
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $scriptHash = "${{ steps.checksums.outputs.script_hash }}"

          $notes = @"
          ## Optimize-WsusServer v$version

          ### Downloads

          | File | Description |
          |------|-------------|
          | ``Optimize-WsusServer.ps1`` | Monolithic script for production use |
          | ``Optimize-WsusServer.psd1`` | Module manifest (for module installation) |

          ### Quick Start

          **Option 1: Monolithic Script (Recommended for production)**

          ``````powershell
          # Download and run
          .\Optimize-WsusServer.ps1 -HealthCheck
          ``````

          **Option 2: PowerShell Module (For development)**

          ``````powershell
          # Clone repository and import
          Import-Module .\Optimize-WsusServer.psd1
          Get-WsusHealthStatus
          ``````

          ### Requirements

          - Windows Server 2012 R2 / 2016 / 2019 / 2022 / 2025
          - Windows PowerShell 5.1 (not PowerShell 7)
          - SqlServer PowerShell module
          - Administrator privileges

          ### Checksums

          ``````
          Optimize-WsusServer.ps1 SHA256: $scriptHash
          ``````

          ### Documentation

          Full documentation available at [docs/](https://github.com/lusoris/Optimize-WsusServer/tree/main/docs)
          "@

          $notes | Out-File -FilePath release-notes.md -Encoding utf8

      - name: Create module archive
        shell: pwsh
        run: |
          # Create a zip with module files for those who want the full module
          $moduleFiles = @(
            'Optimize-WsusServer.psd1',
            'Optimize-WsusServer.psm1',
            'Public',
            'Private',
            'Data',
            'LICENSE',
            'README.md'
          )

          $tempDir = New-Item -ItemType Directory -Path './release-module' -Force
          foreach ($file in $moduleFiles) {
            if (Test-Path $file) {
              Copy-Item -Path $file -Destination $tempDir -Recurse -Force
            }
          }

          Compress-Archive -Path "$tempDir/*" -DestinationPath './Optimize-WsusServer-Module.zip' -Force
          Remove-Item $tempDir -Recurse -Force

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: "Optimize-WsusServer v${{ steps.version.outputs.version }}"
          body_path: release-notes.md
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
          files: |
            dist/Optimize-WsusServer.ps1
            Optimize-WsusServer.psd1
            Optimize-WsusServer-Module.zip
            LICENSE
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-gallery:
    name: Publish to PowerShell Gallery
    needs: build
    runs-on: windows-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $version = $tag -replace '^v', ''
          "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Update module version
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $manifestPath = './Optimize-WsusServer.psd1'

          # Read manifest
          $manifest = (Get-Content $manifestPath) -join "`n"

          # Update version
          $manifest = $manifest -replace "ModuleVersion\s*=\s*'[\d.]+(?:-[\w]+)?'", "ModuleVersion = '$version'"

          # Update PreRelease suffix if version contains hyphen (e.g., 2.1.0-beta)
          if ($version -match '-') {
              $manifest = $manifest -replace "Prerelease\s*=\s*'.*?'", "Prerelease = '$($version -replace '^[\d.]+-(.*)', '$1')'"
          } else {
              $manifest = $manifest -replace ",\s*Prerelease\s*=\s*'.*?'", ''
          }

          Set-Content -Path $manifestPath -Value $manifest
          Write-Host "✓ Updated manifest version to $version"

      - name: Validate module for gallery
        shell: pwsh
        run: |
          try {
              $manifest = Test-ModuleManifest -Path './Optimize-WsusServer.psd1' -WarningAction Ignore -ErrorAction Stop
              Write-Host "✓ Module validation passed"
              Write-Host "  Name: $($manifest.Name)"
              Write-Host "  Version: $($manifest.Version)"
              Write-Host "  Functions: $($manifest.ExportedFunctions.Count)"
              Write-Host "  Author: $($manifest.Author)"
          }
          catch {
              Write-Host "::error::Module validation failed: $_"
              exit 1
          }

      - name: Publish to PowerShell Gallery
        shell: pwsh
        env:
          NUGET_KEY: ${{ secrets.NUGET_KEY }}
        run: |
          # Only publish if NuGet API key is configured
          if (-not $env:NUGET_KEY) {
              Write-Host "::warning::NUGET_KEY secret not configured. Skipping PowerShell Gallery publish."
              Write-Host "To enable publishing, add your PowerShell Gallery API key as 'NUGET_KEY' secret in GitHub settings."
              exit 0
          }

          try {
              Publish-Module -Path '.' -NuGetApiKey $env:NUGET_KEY -Force -WarningAction SilentlyContinue -ErrorAction Stop
              Write-Host "✓ Successfully published to PowerShell Gallery"
          }
          catch {
              Write-Host "::error::Failed to publish to PowerShell Gallery: $_"
              Write-Host ""
              Write-Host "Note: Ensure your module can be published:"
              Write-Host "  1. All functions are in Public/ or Private/ folders"
              Write-Host "  2. Module manifest (psd1) is in repo root"
              Write-Host "  3. Version in psd1 matches the release tag"
              Write-Host "  4. All required module files are included"
              exit 1
          }

      - name: Create publish notification
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          Write-Host "✓ Release v$version completed"
          Write-Host ""
          Write-Host "Module available at:"
          Write-Host "  PowerShell Gallery: https://www.powershellgallery.com/packages/Optimize-WsusServer/$version"
          Write-Host "  GitHub Releases: https://github.com/${{ github.repository }}/releases/tag/v$version"

  post-release:
    name: Post-Release Tasks
    needs: [build, publish-gallery]
    runs-on: windows-latest
    if: success()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get release version
        id: version
        shell: pwsh
        run: |
          $tag = "${{ github.ref_name }}"
          $version = $tag -replace '^v', ''
          "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Update changelog entry
        shell: pwsh
        run: |
          $version = "${{ steps.version.outputs.version }}"
          $date = Get-Date -Format "yyyy-MM-dd"

          # If CHANGELOG.md exists, add entry (optional)
          if (Test-Path './CHANGELOG.md') {
              $changelog = Get-Content './CHANGELOG.md' -Raw
              $newEntry = @"
          ## [$version] - $date

          ### Release
          - Published v$version to PowerShell Gallery and GitHub Releases
          - All fixes and features from this release are documented in release notes

          "@

              $updated = $newEntry + $changelog
              Set-Content './CHANGELOG.md' -Value $updated
              Write-Host "✓ Updated CHANGELOG.md"
          } else {
              Write-Host "ℹ No CHANGELOG.md found - skipping"
          }

      - name: Create commit for version bump
        shell: pwsh
        run: |
          # Check if manifest was updated
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if (git status --porcelain) {
              git add Optimize-WsusServer.psd1 CHANGELOG.md 2>$null
              git commit -m "chore(release): bump version to v${{ steps.version.outputs.version }}" 2>$null || $true
              git push 2>$null || $true
              Write-Host "✓ Created version bump commit"
          } else {
              Write-Host "ℹ No changes to commit"
          }
