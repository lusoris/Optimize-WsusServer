name: CI

on:
  push:
    branches: [ main, develop ]
    paths:
      - '**.ps1'
      - '**.psm1'
      - '**.psd1'
      - 'PSScriptAnalyzerSettings.psd1'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - '**.ps1'
      - '**.psm1'
      - '**.psd1'
      - 'PSScriptAnalyzerSettings.psd1'
      - '.github/workflows/ci.yml'
  workflow_dispatch:

jobs:
  lint:
    name: PSScriptAnalyzer
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser

          # Analyze all PS1 files in Public, Private, Build, Templates
          $paths = @(
            './Public',
            './Private',
            './Build',
            './Templates'
          ) | Where-Object { Test-Path $_ }

          $results = @()
          foreach ($path in $paths) {
            $results += Invoke-ScriptAnalyzer -Path $path -Recurse -Settings ./PSScriptAnalyzerSettings.psd1
          }

          # Also check module files
          if (Test-Path './Optimize-WsusServer.psm1') {
            $results += Invoke-ScriptAnalyzer -Path './Optimize-WsusServer.psm1' -Settings ./PSScriptAnalyzerSettings.psd1
          }

          if ($results) {
              $results | Format-Table -AutoSize
              Write-Host ""
              Write-Host "::error::PSScriptAnalyzer found $($results.Count) issue(s)"

              # Count by severity
              $errors = ($results | Where-Object Severity -eq 'Error').Count
              $warnings = ($results | Where-Object Severity -eq 'Warning').Count
              $info = ($results | Where-Object Severity -eq 'Information').Count

              Write-Host "Errors: $errors, Warnings: $warnings, Information: $info"

              # Fail on errors only (warnings allowed for now during refactoring)
              if ($errors -gt 0) {
                  Write-Host "::error::Failing due to $errors error(s)"
                  exit 1
              }
          } else {
              Write-Host "No issues found by PSScriptAnalyzer"
          }

  syntax-check:
    name: Syntax Check
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check PowerShell Syntax
        shell: pwsh
        run: |
          $hasErrors = $false

          # Check all PS1 files
          Get-ChildItem -Path . -Filter *.ps1 -Recurse -Exclude 'dist' | ForEach-Object {
              $file = $_.FullName
              $errors = $null
              $null = [System.Management.Automation.Language.Parser]::ParseFile($file, [ref]$null, [ref]$errors)

              if ($errors) {
                  Write-Host "::error file=$file::Syntax errors found in $($_.Name)"
                  $errors | ForEach-Object {
                      Write-Host "  Line $($_.Extent.StartLineNumber): $($_.Message)"
                  }
                  $hasErrors = $true
              } else {
                  Write-Host "OK: $($_.Name)"
              }
          }

          # Check PSM1 file
          if (Test-Path './Optimize-WsusServer.psm1') {
              $errors = $null
              $null = [System.Management.Automation.Language.Parser]::ParseFile('./Optimize-WsusServer.psm1', [ref]$null, [ref]$errors)
              if ($errors) {
                  Write-Host "::error::Syntax errors found in Optimize-WsusServer.psm1"
                  $hasErrors = $true
              } else {
                  Write-Host "OK: Optimize-WsusServer.psm1"
              }
          }

          if ($hasErrors) {
              exit 1
          }

  manifest-check:
    name: Module Manifest Validation
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate Module Manifest
        shell: pwsh
        run: |
          $manifestPath = './Optimize-WsusServer.psd1'

          if (-not (Test-Path $manifestPath)) {
              Write-Host "::error::Module manifest not found"
              exit 1
          }

          # Test manifest is valid
          try {
              $manifest = Test-ModuleManifest -Path $manifestPath -ErrorAction Stop
              Write-Host "Module: $($manifest.Name)"
              Write-Host "Version: $($manifest.Version)"
              Write-Host "GUID: $($manifest.GUID)"
              Write-Host "Functions to export: $($manifest.ExportedFunctions.Count)"

              # List exported functions
              $manifest.ExportedFunctions.Keys | ForEach-Object {
                  Write-Host "  - $_"
              }
          }
          catch {
              Write-Host "::error::Module manifest validation failed: $_"
              exit 1
          }

          # Verify all exported functions exist
          $manifest = Import-PowerShellDataFile $manifestPath
          $missingFunctions = @()

          foreach ($func in $manifest.FunctionsToExport) {
              $found = Get-ChildItem -Path './Public' -Filter '*.ps1' -Recurse |
                  Get-Content -Raw |
                  Select-String -Pattern "function\s+$func\s*\{" -Quiet

              if (-not $found) {
                  $missingFunctions += $func
              }
          }

          if ($missingFunctions.Count -gt 0) {
              Write-Host "::warning::Functions in manifest but not found in Public/:"
              $missingFunctions | ForEach-Object { Write-Host "  - $_" }
          }

          Write-Host "Manifest validation passed"

  build:
    name: Build Monolithic Script
    runs-on: windows-latest
    needs: [syntax-check, manifest-check]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build monolithic script
        shell: pwsh
        run: |
          .\Build\Build-MonolithicScript.ps1

      - name: Validate built script
        shell: pwsh
        run: |
          $scriptPath = './dist/Optimize-WsusServer.ps1'

          if (-not (Test-Path $scriptPath)) {
              Write-Host "::error::Build failed - script not created"
              exit 1
          }

          # Syntax check
          $errors = $null
          $null = [System.Management.Automation.Language.Parser]::ParseFile($scriptPath, [ref]$null, [ref]$errors)

          if ($errors) {
              Write-Host "::error::Syntax errors in built script"
              $errors | ForEach-Object { Write-Host $_.Message }
              exit 1
          }

          $fileInfo = Get-Item $scriptPath
          Write-Host "Build successful!"
          Write-Host "  Size: $([math]::Round($fileInfo.Length / 1KB, 1)) KB"
          Write-Host "  Lines: $((Get-Content $scriptPath).Count)"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: Optimize-WsusServer
          path: dist/Optimize-WsusServer.ps1
          retention-days: 7

  pester-test:
    name: Pester Tests
    runs-on: windows-latest
    needs: [build]
    if: ${{ hashFiles('Tests/*.Tests.ps1') != '' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Pester Tests
        shell: pwsh
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module -Name Pester -Force -Scope CurrentUser -MinimumVersion 5.0

          $config = New-PesterConfiguration
          $config.Run.Path = './Tests'
          $config.Output.Verbosity = 'Detailed'
          $config.TestResult.Enabled = $true
          $config.TestResult.OutputPath = './TestResults/results.xml'

          Invoke-Pester -Configuration $config
